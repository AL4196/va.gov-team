# How to Gain Shell Access for Staging/Dev
## Prerequisites:
1. [department-of-veterans-affairs/devops](https://github.com/department-of-veterans-affairs/devops) repository checked out
1. macOS / Win10 + WSL + Ubuntu / Your Favorite *nix
1. [Homebrew](https://brew.sh/) / [Apt](https://wiki.debian.org/AptCLI) / Your Favorite Package Manager

## Actions
1. Use the [Environment Access Request Template](https://github.com/department-of-veterans-affairs/va.gov-team/issues/new?assignees=&labels=external-request%2C+operations&template=Environment-Access-Request-Template.md&title=Access+for+%5Bindividual%5D) to request AWS console access.
    * Be sure to follow the instructions within the issue template
    * You need to have AWS IAM access before you can proceed
1. Setup your AWS account with MFA and create credentials
    * Steps borrowed from [aws-account-setup.md](https://github.com/department-of-veterans-affairs/va.gov-team/blob/master/platform/engineering/backend/aws-account-setup.md)
    1. Sign in to AWS web console
    1. Navigate to IAM dashboard `Users` [here](https://console.amazonaws-us-gov.com/iam/home?region=us-gov-west-1#/home)
    1. Find your user and click the link on your user name
    1. Select `Security Credentials` tab
    1. Locate the `Sign-in credentials` section of the page
    1. Beside `Assigned MFA device`, click `Manage`
    1. Install a virtual MFA app on your smarthpone
        * Google authenticator
        * Microsoft authenticator
        * Other options for TOTP codes
    1. Complete the wizard to pair your virtual MFA
    1. Locate the `Access keys` section of the page
    1. Click the `Create access key` button
        * Use the dialog to download and store the CSV in a secure location
    1. Use the access key information generated by AWS web to populate a new file `~/.aws/credentials`
        * Example:
        ```bash
        [default]
        region = us-gov-west-1
        aws_access_key_id = <ACCESS_KEY>
        aws_secret_access_key = <SECRET_KEY>
        ```
1. Setup utility script `issue_mfa.sh`
    <details>
    <summary>Linux / Win10+WSL</summary>
    <p>

    1. Create an alias that includes your IAM username for ease of use:

        ```bash
            # create / edit your shell's aliases
            vi ~/.bash_aliases

            # append to bash_aliases
            alias mfa="source /path/to/devops/utilities/issue_mfa.sh <your-case-sensitive-IAM-username>"
        ```

    1. Reload .bashrc
        ```bash
        source ~/.bashrc
        ```
    1. Open your virtual MFA app and grab the code
        1. Test out your alias
            ```bash
            mfa <your-mfa-code>
            AWS Session credentials saved. Will expire in 12 hours
            ```
    </p>
    </details>

    <details>
    <summary>macOS</summary>
    <p>
    Additional requirements for macOS:

    ```bash
    brew install jq
    brew install awscli
    ```
    1. Create an alias that includes your IAM username for ease of use:
    ```bash
        #add new alias to .bash_profile
        vi ~/.bash_profile
        alias mfa="source ~/Repos/devops/utilities/issue_mfa.sh Peter.Hill"
    ```
    1. Reload .bash_profile
        ```bash
        source ~/.bash_profile
        ```
    1. Open your virtual MFA app and grab the code
       1. Test out your alias
            ```bash
            mfa <your-mfa-code>
            AWS Session credentials saved. Will expire in 12 hours
            ```
    </p>
    </details>

2. Setup `ssm-session` utility
    1. Satisfy requirements
        1. [Golang > 1.11](https://golang.org/dl/)
        2. [AWS SSM Session Manager plugin](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html)
        3. [AWS CLI version >= 1.16.12](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html)
    2. Navigate to `/path/to/devops/utilities/ssm-session`
    3. Build `ssm-session` 
        ```
        go get -d ./...
        go build -o ssm-session main.go
        ```
    4. Make `ssm-session` easier to use
        <details>
        <summary>Linux / Win10+WSL</summary>
        Create a symbolic link:

        ```bash
        sudo ln -s ssm-session /bin/ssm-session
        ```
        </details>

        <details>
        <summary>macOS</summary>
        Add and an alias for `ssm-session`
        
        ```bash
        # add new alias to .bash_profile
        vi ~/.bash_profile
        alias ssm-session="~/Repos/devops/utilities/ssm-session/ssm-session"
        ```
        </details>

    5. Test out `ssm-session`
        ```bash
        ssm-session
        You need to specify at least an environment.
        Usage:
        ssm-session <dev|staging|prod|utility|bake|vagov-dev|vagov-staging|vagov-prod|vagov-utility|dvp-dev|dvp-staging|dvp-sandbox|dvp-prod> <deployment_name> (auto)
        Description: Gets a list of the deployment instances in the environment and uses
        the SSM Session Manager Plugin for AWS CLI to open an interactive session to it.
        The auto option opens a session to the first instance in the list returned.
        2020/02/11 16:56:30 Program exited.
        ```
